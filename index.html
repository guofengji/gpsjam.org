<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hub and spoke</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="css/mapbox-gl.css" rel="stylesheet">
    <script src="js/mapbox-gl.js"></script>
    <script src="js/d3.v4.min.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <script src="js/geojson2h3.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'B612';
            background: #222;
            color: #ddd;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #date {
            font-size: 3em;
            margin-left: 0.2em;
            margin-top: 0.2em;
        }

        input#datepicker {
            margin: 0 auto;
            font-size: 3em;
            margin-left: 0.2em;
            margin-top: 0.2em;
            position: absolute;
            z-index: 1000;
        }

        p {
            margin-left: 1cm;
        }

        @font-face {
            font-family: B612;
            src: url(fonts/B612-Regular.ttf);
        }
    </style>
</head>

<body>
    <input id="datepicker" type="date" value="2022-07-01">
    <div id="map"></div>
    <script>

        // Parse string like "2022-05-13" into a Date.
        function parseDate(str) {
            var mdy = str.split('-');
            return new Date(mdy[0], mdy[1] - 1, mdy[2]);
        }

        const mapDate = parseDate("2022-07-01");

        const INTERFERENCE_HIGH = 'high';
        const INTERFERENCE_MED = 'med';
        const INTERFERENCE_LOW = 'low';

        function interferenceLevel(good_gps, bad_gps) {
            const bad_frac = (bad_gps - 1) / (bad_gps + good_gps);
            if (bad_frac < 0.02) {
                return INTERFERENCE_LOW
            } else if (bad_frac < 0.10) {
                return INTERFERENCE_MED
            } else {
                return INTERFERENCE_HIGH
            }
        }

        // Given an H3 index, return true if its hexagon crosses the anti-meridian.
        function isH3IndexAM(h3Index) {
            const points = h3.h3ToGeoBoundary(h3Index);
            for (let i = 0; i < points.length; i++) {
                let p1 = points[i];
                let p2 = points[(i + 1) % points.length];
                if (Math.abs(p1[1] - p2[1]) > 180.0) {
                    return true;
                }
            }
            return false;
        }

        function loadH3file(date, map) {
            // Convert date to a string like "2022-05-13" with zero-padding.
            const dateStr = date.getUTCFullYear() + "-" + ("0" + (date.getUTCMonth() + 1)).slice(-2) + "-" + ("0" + date.getUTCDate()).slice(-2)
            document.getElementById('datepicker').value = dateStr;
            console.log(`Loading ${date}. Set picker to ${dateStr}`);
            const h3Filename = dateStr + '-h3_4.csv'
            let url = 'data/' + h3Filename;
            // Loop over low, med, high and remove that layer.
            d3.csv(
                url,
                allHexes => {
                    if (map.getLayer('outline')) {
                        map.removeLayer('outline');
                    }
                    for (level of ['low', 'med', 'high']) {
                        const layerName = `${level}`;
                        if (map.getLayer(layerName)) {
                            map.removeLayer(`${level}`);
                            map.removeSource(`${level}-interference-src`);
                        }
                    }
                    addH3CsvToMap(allHexes, map);
                });
        }

        let initLoad = true;

        mapboxgl.accessToken = 'pk.eyJ1Ijoid2lzZW1hbiIsImEiOiJHbzAtOHgwIn0.Pj1Nx77LS1-ujzRKJVOttA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0, 40],
            zoom: 3,
            projection: 'globe',
            // maxZoom: 6
        });

        function addH3CsvToMap(rows, map) {
            // Build GeoJSON from the H3 csv data. We build 3 GeoJSON
            // features: One containing hexes with high interference
            // levels, one with medium interference, and one with low
            // interference.
            let start = Date.now();
            let hexes = {
                'low': [],
                'med': [],
                'high': []
            };
            allHexes = rows.filter(h => !isH3IndexAM(h.hex));
            allHexes.forEach(h => {
                let level = interferenceLevel(
                    parseInt(h.count_good_aircraft),
                    parseInt(h.count_bad_aircraft));
                hexes[level].push(h.hex);
            });
            const lowGeoJson = h3SetToFeatureCollection(hexes[INTERFERENCE_LOW]);
            const medGeoJson = h3SetToFeatureCollection(hexes[INTERFERENCE_MED]);
            const highGeoJson = h3SetToFeatureCollection(hexes[INTERFERENCE_HIGH]);
            console.log(`Creating GeoJSON took ${(Date.now() - start)} ms`);
            map.addSource('low-interference-src', {
                type: 'geojson',
                data: lowGeoJson
            });
            map.addSource('med-interference-src', {
                type: 'geojson',
                data: medGeoJson
            });
            map.addSource('high-interference-src', {
                type: 'geojson',
                data: highGeoJson
            });
            // Add a new layer to visualize the polygon.
            map.addLayer({
                'id': 'high',
                'type': 'fill',
                'source': 'high-interference-src',
                'layout': {},
                'paint': {
                    'fill-color': '#ff3333',
                    'fill-opacity': 0.5
                }
            });
            // map.addLayer({
            //     'id': 'outline',
            //     'type': 'line',
            //     'source': 'high-interference-src',
            //     'layout': {},
            //     'paint': {
            //         'line-color': '#000',
            //         'line-width': 1
            //     }
            // });
            console.log(`Added ${hexes['high'].length} high hexes`);
            map.addLayer({
                'id': 'low',
                'type': 'fill',
                'source': 'low-interference-src',
                'layout': {},
                'paint': {
                    'fill-color': '#33ff33',
                    'fill-opacity': 0.5
                }
            });
            console.log(`Added ${hexes['low'].length} low hexes`);
            map.addLayer({
                'id': 'med',
                'type': 'fill',
                'source': 'med-interference-src', // reference the data source
                'layout': {},
                'paint': {
                    'fill-color': '#ffff33',
                    'fill-opacity': 0.5
                }
            });
            console.log(`Adding sources and layers took ${(Date.now() - start)} ms`);
            console.log(`Added ${hexes['med'].length} med hexes`);

        }

        map.on('load', () => {
            map.once('idle', () => {
                loadH3file(mapDate, map);
            });
        });

        // When the date picker value changes, load that day's data.
        document.getElementById('datepicker').addEventListener('change', function () {
            const date = new Date(this.value);
            loadH3file(date, map);
        });
    </script>
</body>

</html>